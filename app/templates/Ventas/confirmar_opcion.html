{% extends "base.html" %}
{% block title %}Confirmar opción — {{ s.numero_serie }}{% endblock %}
{% block content %}
<div class="container my-3">
  <div class="d-flex justify-content-between align-items-center">
    <h4 class="mb-0">Confirmar opción — Solicitud {{ s.numero_serie }}</h4>
    <a class="btn btn-outline-secondary" href="{{ url_for('ventas.comparar_opciones', sol_id=s.id) }}">Volver</a>
  </div>
  <div class="text-muted">Cliente: {{ s.cliente }}</div>

  <div class="card mt-3">
    <div class="card-body">
      <div class="d-flex flex-wrap gap-3">
        <div><span class="text-muted small">Tipo:</span> <strong>{{ op.tipo_servicio|capitalize }}</strong></div>
        <div><span class="text-muted small">Moneda:</span> <strong>{{ op.moneda }}</strong></div>
        <div><span class="text-muted small">CBM cotizado:</span> <strong>{{ op.cbm_cotizado or '—' }}</strong></div>
        <div><span class="text-muted small">TT (pricing):</span> <strong>{{ op.transito_estimado_dias or '—' }}</strong></div>
        <div><span class="text-muted small">Días libres:</span> <strong>{{ op.dias_libres_destino or '—' }}</strong></div>
      </div>
    </div>
  </div>

  <form class="mt-3" method="POST">
    {{ csrf_token() if csrf_token is defined }}

    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Vigencia de la oferta</label>
        <input name="vigencia_oferta" class="form-control" placeholder="ej. 7 días" required>
      </div>
      <div class="col-md-4">
        <label class="form-label">Nombre del solicitante</label>
        <input name="solicitante_nombre" class="form-control" required>
      </div>
      <div class="col-md-4">
        <label class="form-label">Email del solicitante</label>
        <input type="email" name="solicitante_email" class="form-control" required>
      </div>
      <div class="col-md-4">
        <label class="form-label">Teléfono del solicitante</label>
        <input name="solicitante_tel" class="form-control">
      </div>
      <div class="col-12">
        <label class="form-label">Términos y condiciones internos (CompassSolutions)</label>
        <textarea name="tyc_internos" class="form-control" rows="3" placeholder="Texto adicional interno que se anexará a la oferta"></textarea>
      </div>

      <!-- NUEVOS CAMPOS -->
      <div class="col-md-4">
        <label class="form-label">Markup (%) Ventas</label>
        <input
          type="number" step="0.01" min="0" inputmode="decimal"
          name="markup_pct"
          class="form-control"
          placeholder="ej. 23.1"
          value="{{ markup_pct|default('', true) }}"
        >
        <div class="form-text">Escribe el porcentaje (ej. 23.1 = 23.1%).</div>
      </div>
      <div class="col-md-4">
        <label class="form-label">TT (días) en Ventas</label>
        <input
          type="number" step="1" min="0" inputmode="numeric"
          name="tt_ventas_dias"
          class="form-control"
          placeholder="ej. 15"
          value="{{ tt_ventas_dias|default(op.transito_estimado_dias, true) }}"
        >
      </div>
      <!-- /NUEVOS CAMPOS -->
    </div>

    <div class="mt-4">
      <button class="btn btn-primary">Confirmar y continuar</button>
      <a class="btn btn-outline-secondary" href="{{ url_for('ventas.comparar_opciones', sol_id=s.id) }}">Cancelar</a>
    </div>
  </form>

  <hr class="my-4">

  <div class="table-responsive">
    <table class="table table-sm">
      <thead>
        <tr>
          <th>Tipo</th><th>Concepto</th><th>Proveedor</th><th>Moneda</th>
          <th>Unidad</th><th class="text-end">Cant.</th>
          <th class="text-end">Tarifa</th><th class="text-end">PS</th>
          <th class="text-end">Costo</th><th class="text-end">IVA $</th>
          <th class="text-end">Ret $</th><th class="text-end">Costo total</th>
        </tr>
      </thead>
      <tbody>
        {% for it in rows %}
          {% set cantidad = (it.cantidad or 0)|float %}
          {% set unit = (it.precio_unit or 0)|float %}
          {% set base = cantidad * unit %}
          {% set iva  = base * ((it.iva_pct or 0)|float) %}
          {% set ret  = base * ((it.ret_iva_pct or 0)|float) %}
          {% set total = base + iva + ret %}
          <tr>
            <td>{{ 'Flete' if (it.ps or 0)!=0 else 'Origen/Destino' }}</td>
            <td>{{ it.concepto_nombre or (it.concepto.clave ~ ' — ' ~ it.concepto.descripcion if it.concepto else '') }}</td>
            <td>{{ it.proveedor or '—' }}</td>
            <td>{{ it.moneda }}</td>
            <td>{{ it.unidad or '—' }}</td>
            <td class="text-end">{{ '%.4f'|format(cantidad) }}</td>
            <td class="text-end">{{ '%.2f'|format(unit) }}</td>
            <td class="text-end">{{ '%.2f'|format(it.ps or 0) }}</td>
            <td class="text-end">{{ '%.2f'|format(unit + (it.ps or 0)) }}</td>
            <td class="text-end">{{ '%.2f'|format(iva) }}</td>
            <td class="text-end">{{ '%.2f'|format(ret) }}</td>
            <td class="text-end">{{ '%.2f'|format(total) }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
