{% extends "base.html" %}
{% block title %}{{ 'Editar' if opcion else 'Nueva' }} opción · {{ s.numero_serie }}{% endblock %}
{% block content %}
<div class="container my-3">
  <div class="d-flex justify-content-between align-items-center">
    <h4 class="mb-0">{{ 'Editar' if opcion else 'Nueva' }} opción — Solicitud {{ s.numero_serie }}</h4>
    <a class="btn btn-outline-secondary" href="{{ url_for('pricing.solicitud', sol_id=s.id) }}">Volver</a>
  </div>
  <div class="text-muted">Cliente: {{ s.cliente }}</div>

  <form method="POST">
    {{ csrf_token() if csrf_token is defined }}

    <div class="row g-3 mt-3">
      <div class="col-md-4">
        <label class="form-label">Proveedor (global)</label>
        <input type="text" class="form-control" name="proveedor" value="{{ opcion.proveedor if opcion else '' }}" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">Moneda (global)</label>
        <select name="moneda" class="form-select" id="moneda_global">
          {% for m in ["USD","EUR","MXN"] %}
            <option value="{{m}}" {{ 'selected' if opcion and opcion.moneda==m else '' }}>{{m}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">CBM cotizado {% if is_lcl %}(LCL 0&lt;cbm&lt;1 ⇒ 1){% endif %}</label>
        <input
          type="number" step="0.0001" name="cbm_cotizado" id="cbm_cotizado" class="form-control"
          value="{{ ('%.4f' % opcion.cbm_cotizado) if (opcion and opcion.cbm_cotizado is not none) else (cbm_prefill or '') }}"
        >
      </div>
    </div>

    <div class="row g-3 mt-2">
      <div class="col-md-4"><label class="form-label">Origen final</label><input name="origen_final" class="form-control" value="{{ opcion.origen_final if opcion else '' }}"></div>
      <div class="col-md-4"><label class="form-label">Destino final</label><input name="destino_final" class="form-control" value="{{ opcion.destino_final if opcion else '' }}"></div>
      <div class="col-md-2"><label class="form-label">Frecuencia</label><input name="frecuencia" class="form-control" value="{{ opcion.frecuencia if opcion else '' }}"></div>
      <div class="col-md-2"><label class="form-label">TT (días)</label><input type="number" name="transito_estimado_dias" class="form-control" value="{{ opcion.transito_estimado_dias if opcion else '' }}"></div>
      <div class="col-md-2"><label class="form-label">Días libres</label><input type="number" name="dias_libres_destino" class="form-control" value="{{ opcion.dias_libres_destino if opcion else '' }}"></div>
    </div>

    <div class="mt-2">
      <label class="form-label">Términos y condiciones</label>
      <textarea name="terminos_condiciones" class="form-control" rows="3">{{ opcion.terminos_condiciones if opcion else '' }}</textarea>
    </div>

    <hr class="my-4">

    <div class="d-flex flex-wrap gap-2 align-items-center">
      <h5 class="mb-0 me-2">Conceptos por opción</h5>

      <select class="form-select form-select-sm" style="max-width:460px" id="selAddConcepto">
        <option value="">— Agregar desde catálogo —</option>
        {% for c in conceptos %}
          <option value="{{ c.id }}">{{ c.clave }} — {{ c.descripcion }} ({{ c.moneda }})</option>
        {% endfor %}
        <option value="__OTROS__">Otros… (fila vacía)</option>
      </select>
      <button type="button" class="btn btn-sm btn-outline-primary" id="btnAddItem">+ Agregar</button>
    </div>

    <div class="table-responsive mt-2">
      <table class="table table-sm align-middle" id="tblItems">
        <thead>
          <tr>
            <th style="width:8%">Tipo</th>
            <th style="width:18%">Concepto</th>
            <th>Nombre (OTROS)</th>
            <th style="width:16%">Proveedor</th>
            <th style="width:7%">Moneda</th>
            <th style="width:8%">Unidad</th>
            <th style="width:7%">Cant.</th>
            <th style="width:9%">Tarifa</th>
            <th style="width:7%">PS</th>
            <th style="width:9%">Costo</th>
            <th style="width:10%">Costo total</th>
            <th style="width:7%">IVA %</th>
            <th style="width:8%">IVA $</th>
            <th style="width:7%">Ret %</th>
            <th style="width:8%">Ret $</th>
            <th style="width:6%">TT</th>
            <th style="width:10%">Ruta</th>
            <th style="width:4%"></th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <th colspan="10" class="text-end">Subtotal</th>
            <th class="text-end" id="sum_subtotal">0.00</th>
            <th></th><th class="text-end" id="sum_iva">0.00</th>
            <th></th><th class="text-end" id="sum_ret">0.00</th>
            <th colspan="2"></th>
          </tr>
          <tr class="table-light">
            <th colspan="13" class="text-end">TOTAL</th>
            <th class="text-end" id="sum_total">0.00</th>
            <th colspan="2"></th>
          </tr>
        </tfoot>
      </table>
    </div>

    <input type="hidden" name="items_json" id="items_json">

    <div class="mt-4">
      <button class="btn btn-primary">Guardar opción</button>
      <a class="btn btn-outline-secondary" href="{{ url_for('pricing.solicitud', sol_id=s.id) }}">Cancelar</a>
    </div>
  </form>
</div>

<!-- Datos crudos en JSON -->
<div id="cotizar-data"
     data-opcion-id="{{ opcion.id|default('', true) }}"
     data-servicio="{{ tipo|default('maritimo', true) }}"
     data-is-lcl="{{ '1' if is_lcl else '0' }}"
     data-moneda-default="{{ moneda_default|default('MXN', true) }}"></div>

<script type="application/json" id="catalogo-json">{{ conceptos|tojson }}</script>
<script type="application/json" id="items-json">{{ items|tojson }}</script>

<datalist id="unidadesList">
  <option value="N/A"><option value="Shipment"><option value="BL"><option value="CBM">
  <option value="CW"><option value="Contenedor"><option value="TEU">
  <option value="Kg"><option value="Ton"><option value="Pallet"><option value="Caja">
</datalist>

<script>
/* ===== Helpers DOM ===== */
const q  = (s, c=document)=>c.querySelector(s);
const qa = (s, c=document)=>Array.from(c.querySelectorAll(s));
const toNum = v => { const s=(v??'').toString().trim(); return s===''?0:parseFloat(s); };
const clamp2 = n => isFinite(n) ? Math.round(n*100)/100 : 0;

/* ===== Carga de datos ===== */
const dataEl = q('#cotizar-data');
const IS_LCL     = (dataEl?.dataset.isLcl === '1');
const MONEDA_DEF = (dataEl?.dataset.monedaDefault || 'MXN');

function parseJSONTag(id){
  const el = q(`#${id}`);
  if (!el) return [];
  try { return JSON.parse(el.textContent || '[]'); }
  catch(e){ console.warn('JSON inválido en', id, e); return []; }
}
const CATALOG = parseJSONTag('catalogo-json'); // [{id, clave, descripcion, moneda, unidad, iva_pct, ret_iva_pct, isr_pct}]
let ITEMS = parseJSONTag('items-json');        // backend payload base

/* ===== Referencias UI ===== */
const selAddConcepto = q('#selAddConcepto');
const btnAddItem     = q('#btnAddItem');
const tblBody        = q('#tblItems tbody');
const sumSubtotalEl  = q('#sum_subtotal');
const sumIvaEl       = q('#sum_iva');
const sumRetEl       = q('#sum_ret');
const sumTotalEl     = q('#sum_total');
const hiddenItems    = q('#items_json');
const selMonedaGlob  = q('#moneda_global');

/* ===== Utilidades negocio ===== */
function conceptoById(id){
  id = id==null?null:parseInt(id,10);
  if (!id) return null;
  return CATALOG.find(c => c.id === id) || null;
}

// Regla LCL: si la unidad es CBM y 0< cantidad <1 => 1 (sólo para el cálculo)
function normalizeCantidad(unidad, cant){
  let c = toNum(cant);
  if (IS_LCL && (unidad||'').toUpperCase()==='CBM' && c>0 && c<1) c = 1;
  return c;
}

function computeLine(row){
  const tipo    = (row.tipo || 'Origen');
  const unidad  = (row.unidad || '');
  const cant    = normalizeCantidad(unidad, row.cantidad);
  const tarifa  = toNum(row.tarifa);
  const ps      = (tipo === 'Flete') ? toNum(row.ps) : 0;
  const costo   = tarifa + ps;                  // unitario
  const base    = cant * costo;                 // costo total

  const ivaPct  = toNum(row.iva_pct);
  const retPct  = toNum(row.ret_iva_pct);
  const isrPct  = toNum(row.isr_pct);

  const iva  = base * ivaPct;
  const ret  = base * retPct;
  const isr  = base * isrPct;                   // por si lo usas
  const total = base + iva - ret - isr;

  return { costo, base, iva, ret, isr, total };
}

function asBackendPayload(row){
  const tipo = (row.tipo || 'Origen');
  const unidad = (row.unidad || '');
  const cantidad = normalizeCantidad(unidad, row.cantidad);
  const tarifa = toNum(row.tarifa);
  const ps = (tipo === 'Flete') ? toNum(row.ps) : 0;

  return {
    concepto_id: row.concepto_id ?? null,
    concepto_nombre: row.concepto_nombre || '',
    proveedor: row.proveedor || '',
    moneda: row.moneda || MONEDA_DEF,
    unidad: unidad || null,
    cantidad: cantidad,
    // IMPORTANTE: lo que persiste el backend
    precio_unit: tarifa + ps,
    iva_pct: toNum(row.iva_pct),
    ret_iva_pct: toNum(row.ret_iva_pct),
    isr_pct: toNum(row.isr_pct),
    // extras futuros (backend los ignorará por ahora)
    tipo: tipo,
    ps: ps,
    tt: row.tt || null,
    ruta: row.ruta || null,
  };
}

function renderItems(){
  tblBody.innerHTML = '';
  ITEMS.forEach((it, idx) => {
    const calc = computeLine(it);
    const tr = document.createElement('tr');

    const isFlete = (it.tipo || 'Origen') === 'Flete';

    tr.innerHTML = `
      <td>
        <select class="form-select form-select-sm" data-k="tipo">
          ${['Origen','Flete','Destino'].map(t=>`<option value="${t}" ${t===(it.tipo||'Origen')?'selected':''}>${t}</option>`).join('')}
        </select>
      </td>
      <td>
        <input class="form-control form-control-sm" data-k="concepto_nombre" value="${it.concepto_nombre||''}" placeholder="Clave — Descripción">
        <input type="hidden" data-k="concepto_id" value="${it.concepto_id??''}">
      </td>
      <td>
        <input class="form-control form-control-sm" data-k="nombre_otros" value="${it.nombre_otros||''}" placeholder="Si no es del catálogo">
      </td>
      <td><input class="form-control form-control-sm" data-k="proveedor" value="${it.proveedor||''}" placeholder="Proveedor"></td>
      <td>
        <select class="form-select form-select-sm" data-k="moneda">
          ${['MXN','USD','EUR'].map(m=>`<option value="${m}" ${m===(it.moneda||MONEDA_DEF)?'selected':''}>${m}</option>`).join('')}
        </select>
      </td>
      <td><input class="form-control form-control-sm" list="unidadesList" data-k="unidad" value="${it.unidad||''}"></td>
      <td><input class="form-control form-control-sm text-end" type="number" step="0.0001" data-k="cantidad" value="${it.cantidad??''}" title="${IS_LCL?'LCL: si unidad=CBM y 0<cant<1 → 1':''}"></td>
      <td><input class="form-control form-control-sm text-end" type="number" step="0.01" data-k="tarifa" value="${it.tarifa??(toNum(it.precio_unit)||0)}"></td>
      <td><input class="form-control form-control-sm text-end" type="number" step="0.01" data-k="ps" value="${it.ps??0}" ${isFlete?'':'disabled'}></td>
      <td class="text-end">${clamp2(calc.costo).toFixed(2)}</td>
      <td class="text-end">${clamp2(calc.base).toFixed(2)}</td>
      <td><input class="form-control form-control-sm text-end" type="number" step="0.0001" data-k="iva_pct" value="${it.iva_pct??0}"></td>
      <td class="text-end">${clamp2(calc.iva).toFixed(2)}</td>
      <td><input class="form-control form-control-sm text-end" type="number" step="0.0001" data-k="ret_iva_pct" value="${it.ret_iva_pct??0}"></td>
      <td class="text-end">${clamp2(calc.ret).toFixed(2)}</td>
      <td><input class="form-control form-control-sm text-end" type="number" step="1" data-k="tt" value="${it.tt??''}" ${isFlete?'':'disabled'}></td>
      <td><input class="form-control form-control-sm" data-k="ruta" value="${it.ruta||''}" ${isFlete?'':'disabled'}></td>
      <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger" data-del>&times;</button></td>
    `;

    // Wire inputs
    qa('[data-k]', tr).forEach(inp=>{
      inp.addEventListener('input', ()=>{
        const key = inp.dataset.k;
        let val = inp.value;
        if (['cantidad','tarifa','ps','iva_pct','ret_iva_pct','isr_pct','tt'].includes(key)) val = toNum(val);
        ITEMS[idx][key] = val;

        // Activar/desactivar campos según tipo
        if (key === 'tipo'){
          const isF = (val === 'Flete');
          qa('[data-k="ps"]', tr).forEach(x=>{ x.disabled = !isF; if(!isF){ x.value = ''; ITEMS[idx].ps = 0; } });
          qa('[data-k="tt"]', tr).forEach(x=>{ x.disabled = !isF; if(!isF){ x.value = ''; ITEMS[idx].tt = null; } });
          qa('[data-k="ruta"]', tr).forEach(x=>{ x.disabled = !isF; if(!isF){ x.value = ''; ITEMS[idx].ruta = null; } });
        }

        renderItems();
        computeTotals();
      });
    });
    tr.querySelector('[data-del]').addEventListener('click', ()=>{
      ITEMS.splice(idx,1);
      renderItems();
      computeTotals();
    });

    tblBody.appendChild(tr);
  });

  // Sync hidden JSON (backend payload)
  hiddenItems.value = JSON.stringify(ITEMS.map(asBackendPayload));
}

function computeTotals(){
  // Suma por moneda
  const byM = {};
  ITEMS.forEach(it=>{
    const m = (it.moneda || MONEDA_DEF);
    const r = computeLine(it);
    byM[m] ??= {sub:0, iva:0, ret:0, isr:0, total:0};
    byM[m].sub   += r.base;
    byM[m].iva   += r.iva;
    byM[m].ret   += r.ret;
    byM[m].isr   += r.isr;
    byM[m].total += r.total;
  });

  const m = selMonedaGlob ? selMonedaGlob.value : MONEDA_DEF;
  const t = byM[m] || {sub:0, iva:0, ret:0, isr:0, total:0};
  sumSubtotalEl.textContent = `${clamp2(t.sub).toFixed(2)} ${m}`;
  sumIvaEl.textContent      = `${clamp2(t.iva).toFixed(2)} ${m}`;
  sumRetEl.textContent      = `${clamp2(t.ret).toFixed(2)} ${m}`;
  sumTotalEl.textContent    = `${clamp2(t.total).toFixed(2)} ${m}`;
}

/* ===== Acciones ===== */
function addFromConcepto(c){
  const base = {
    // extras UI
    tipo: 'Origen',
    tarifa: 0,
    ps: 0,
    tt: null,
    ruta: '',
    nombre_otros: '',
    // persistibles
    concepto_id: c?.id || null,
    concepto_nombre: c ? `${c.clave} — ${c.descripcion}` : '',
    proveedor: '',
    moneda: c?.moneda || (selMonedaGlob? selMonedaGlob.value : MONEDA_DEF),
    unidad: (c?.unidad || '').toUpperCase(),
    cantidad: 1,
    precio_unit: 0, // no se usa directo; tarifa + ps → precio_unit al guardar
    iva_pct: toNum(c?.iva_pct),
    ret_iva_pct: toNum(c?.ret_iva_pct),
    isr_pct: toNum(c?.isr_pct),
  };
  ITEMS.push(base);
  renderItems();
  computeTotals();
}

document.addEventListener('DOMContentLoaded', ()=>{
  // Normaliza items que vienen del backend
  ITEMS = (ITEMS || []).map(it=>{
    const c = it.concepto_id ? conceptoById(it.concepto_id) : null;
    return {
      // UI extras por defecto
      tipo: it.tipo || 'Origen',
      tarifa: toNum(it.precio_unit || 0), // asumimos que precio_unit = tarifa (sin PS guardado)
      ps: toNum(it.ps || 0),              // si existiera en JSON, lo respetamos
      tt: it.tt || null,
      ruta: it.ruta || '',
      nombre_otros: it.concepto_id ? '' : (it.concepto_nombre || ''),

      // persistibles
      concepto_id: it.concepto_id ?? null,
      concepto_nombre: it.concepto_nombre || (c ? `${c.clave} — ${c.descripcion}` : ''),
      proveedor: it.proveedor || '',
      moneda: it.moneda || MONEDA_DEF,
      unidad: (it.unidad || c?.unidad || '').toUpperCase(),
      cantidad: toNum(it.cantidad),
      precio_unit: toNum(it.precio_unit),
      iva_pct: toNum(it.iva_pct ?? c?.iva_pct),
      ret_iva_pct: toNum(it.ret_iva_pct ?? c?.ret_iva_pct),
      isr_pct: toNum(it.isr_pct ?? c?.isr_pct),
    };
  });

  renderItems();
  computeTotals();

  selMonedaGlob?.addEventListener('change', computeTotals);

  selAddConcepto?.addEventListener('change', ()=>{
    const v = selAddConcepto.value;
    if (!v) return;
    if (v === '__OTROS__'){
      addFromConcepto(null);
    } else {
      const c = conceptoById(parseInt(v,10));
      addFromConcepto(c);
    }
    selAddConcepto.value = '';
  });

  btnAddItem?.addEventListener('click', ()=> addFromConcepto(null));
});
</script>
{% endblock %}
